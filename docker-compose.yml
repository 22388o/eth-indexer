version: "3"
services:
  geth:
    image: quay.io/amis/geth:mysql_1.8.3
    ports:
      - "30303:30303"
      - "8546:8546"
    volumes:
      - ./geth-data:/root/.ethereum
    command: "--ws --wsaddr 0.0.0.0 --wsport 8546 --wsorigins \"*\" --mysql --mysql.address ws-database --mysql.password my-secret-pw --mysql.database eth-db"
    restart: always
    depends_on:
      - ws-database
  ws-database:
    image: mysql:5.7
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=my-secret-pw
      - MYSQL_CHARSET=utf8
      - MYSQL_DATABASE=eth-db
  ws-migration:
    build:
      context: ./migration
    command: ["rake", "db:migrate"]
    restart: on-failure
    depends_on:
      - ws-database
    environment:
      - RAILS_ENV=customized
      - HOST=ws-database
      - PORT=3306
      - DATABASE=eth-db
      - USERNAME=root
      - PASSWORD=my-secret-pw
  ws-rpc:
    build:
      context: .
      dockerfile: ./cmd/service/Dockerfile
    command:
      - rpc
      - --db.host
      - ws-database
    ports:
      - 5487:5487
    restart: always
    depends_on:
      - ws-database
      - ws-migration
  ws-proxy:
    build:
      context: .
      dockerfile: ./cmd/service/Dockerfile
    command:
      - proxy
      - --grpc.host
      - ws-rpc
    ports:
      - 8080:8080
    restart: always
  ws-indexer:
    build:
      context: .
      dockerfile: ./cmd/service/Dockerfile
    command:
      - indexer
      - --db.host
      - ws-database
      - --eth.host
      - geth # geth --ws --wsaddr 0.0.0.0 --wsport 8546 --wsorigins "*"
      - --start
      - "2000000"
      - --end
      - "2000100"
      - --listen
    restart: on-failure
    depends_on:
      - ws-database
      - ws-migration
      - geth
